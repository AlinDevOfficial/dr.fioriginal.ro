/* Plugin generated by AMXX-Studio */

#include <amxmodx>
#include <engine>
#include <fakemeta>
#include <hamsandwich>
#define PLUGIN "Alpha.Da"
#define VERSION "0.0.1.a"
#define AUTHOR "skitaila03"
#pragma semicolon 1

new g_TimeS[MAX_PLAYERS], g_TimeM[MAX_PLAYERS];\
new StatusText;
new bool:hide[MAX_PLAYERS];

const OFFSET_CSTEAMS = 114;

public plugin_init() {
	register_plugin(PLUGIN, VERSION, AUTHOR);
	register_message(get_user_msgid("StatusValue"), "update_target");
	RegisterHam(Ham_Spawn, "player", "Fwd_PlayerSpawn_Post", 1);
	RegisterHam(Ham_Killed, "player", "Fwd_PlayerKilled_Pre", 0);
	register_event("StatusValue", "EventStatusValueShow", "be", "1=2", "2!0"); // Daca sub tinta este jucator
  register_event("StatusValue", "EventStatusValueHide", "be", "1=1", "2=0"); // Daca sub tinta NU este jucator
	StatusText = get_user_msgid("StatusText");
}

public client_disconnect(id)
	{
	if(task_exists(id + 5551))
		remove_task(id + 5551);
}

public Fwd_PlayerSpawn_Post(const id)
	{
	if( fm_get_user_team(id) == 2 )
		{
		g_TimeS[id] = 0;
		g_TimeM[id] = 0;
		if(task_exists(id + 5551))
			remove_task(id + 5551);
		set_task( 1.0, "Timer",id + 5551, _, _, "b" );
	}
	else
	{
		if(task_exists(id + 5551))
			remove_task(id + 5551);
		g_TimeS[id] = 0;
		g_TimeM[id] = 0;
	}
}

public EventStatusValueShow(id)
{
  hide[id] = false;
}

public EventStatusValueHide(id)
{
  hide[id] = true;
}

public Timer(id)
	{
	id -= 5551;
	g_TimeS[id]++;
	if( g_TimeS[id] == 60)
		{
		g_TimeS[id] = 0;
		g_TimeM[id]++; 
	}
	if( hide[id] )
	{
    new sSMsg[32];
    format(sSMsg, 31, "Your time: %02d:%02d", g_TimeM[id], g_TimeS[id]);
    message_begin(MSG_ONE, StatusText, {0,0,0}, id);
    write_byte(0);
    write_string(sSMsg);
    message_end();
	}
}

public Fwd_PlayerKilled_Pre(victim, attacker, shouldgib)
	{
	if(fm_get_user_team(victim) == 1       
	&& fm_get_user_team(attacker) == 2)
	{
		if( g_TimeS[attacker] > 30 )
		{
			if( g_TimeM[attacker] >= 1 )
				client_print_color(0, print_team_red, "^1 [Dr.FioriGinal.Ro] ^4%s^3 a ucis teroristul ^4%s^3 in %d minut%s si %d secund%s",szName(attacker) ,szName(victim), g_TimeM[attacker], ( (g_TimeM[attacker]>1 || g_TimeM[attacker] == 0)?"e":""), g_TimeS[attacker], ((g_TimeS[attacker]>1 || g_TimeS[attacker] == 0)?"e":""));
			else    
			client_print_color(0, print_team_red, "^1 [Dr.FioriGinal.Ro] ^4%s^3 a ucis teroristul ^4%s^3 in %d secund%s",szName(attacker), szName(victim), g_TimeS[attacker], ((g_TimeS[attacker]>1 || g_TimeS[attacker] == 0)?"e":"")); 
		}
	}
	return HAM_IGNORED;
}

stock szName(id)
	{
	new sz_Name[32 + 1];
	
	get_user_name(id, sz_Name, charsmax(sz_Name));
	
	return sz_Name;
}

stock fm_get_user_team( id )
{
   return get_pdata_int( id, OFFSET_CSTEAMS );
} 